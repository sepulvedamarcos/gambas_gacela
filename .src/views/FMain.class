' Gambas class file

Private $width As Integer = 160
Private $height As Integer = 90

Private $configuration As Configuration
Private $log4Gambas As Log4Gambas3
Private $photoService As PhotoService
Private $formPhotos As FPhoto

Public Sub _new(configuration As Configuration, logger As Log4Gambas3, photoService As PhotoService)

  $configuration = configuration
  $log4Gambas = logger
  $photoService = photoService

End

Public Sub Form_Open()

  $log4Gambas.Debug("en formulario open obtenemos los registros de fotos")
  ToggleButtonPersonal.Value = IIf($configuration.whichLibrary = Enumeration.LibraryType_Private, True, False)
  If $configuration.whichLibrary = Enumeration.LibraryType_Private Then
    ToggleButtonPersonal.Picture = Picture.Load("icon:/medium/apply")
  Endif

  ToggleButtonCompartida.Value = IIf($configuration.whichLibrary = Enumeration.LibraryType_Private, False, True)
  If $configuration.whichLibrary = Enumeration.LibraryType_Shared Then
    ToggleButtonCompartida.Picture = Picture.Load("icon:/medium/apply")
  Endif

  ClearPhotoGallery()
  ' TODO: aqui deberia levantar los filtros usados la ultima vez
  CreatePhotoPanels($photoService.loadFirstPage())

End

Public Sub Form_Drop()

  Dim fileDrop As String[]
  Dim selector As FImportar

  $log4Gambas.Debug("Activa drop")

  fileDrop = Drag.Paste("text/uri-list")

  selector = New FImportar($photoService, $log4Gambas)
  selector.ShowDialog()

  $photoService.ImportPhoto(fileDrop, "")

  ' PanelGalleryContent.Children.Clear
  CreatePhotoPanels($photoService.loadNextPage())

End

Public Sub ButtonZoomIn_Click()

  Dim pane As Variant

  For Each pane In PanelGalleryContent.Children
    pane.Width = pane.Width * 1.25
    pane.Height = pane.Height * 1.25
  Next

End

Public Sub ButtonZoomOut_Click()

  Dim pane As Variant

  For Each pane In PanelGalleryContent.Children
    pane.Width = pane.Width / 1.25
    pane.Height = pane.Height / 1.25
  Next

End

Public Sub Libreria_Click()

End

Public Sub ToggleButtonPersonal_Click()

  $log4Gambas.debug("Seleccion de libreria personal")
  ToggleButtonCompartida.Value = False
  $photoService.ToggleLibrary(Enumeration.LibraryType_Private)

End

Public Sub ToggleButtonCompartida_Click()

  $log4Gambas.debug("Seleccion de libreria compartida ")
  ToggleButtonPersonal.Value = False
  $photoService.ToggleLibrary(Enumeration.LibraryType_Shared)

End

Public Sub PanelGalleryContent_Scroll()

  Dim scrollPos As Float
  Dim scrollMax As Float
  Dim threshold As Float = 0.8  ' 80% del scroll

  ' Calcular posici칩n del scroll (0.0 a 1.0)
  scrollMax = PanelGalleryContent.ScrollHeight - PanelGalleryContent.ClientHeight

  If scrollMax <= 0 Then Return

  scrollPos = PanelGalleryContent.ScrollY / scrollMax

  ' Si lleg칩 al 80% y no est치 cargando, cargar m치s
  If scrollPos >= threshold Then
    CreatePhotoPanels($photoService.loadNextPage())
  Endif

End

Public Sub Button5_Click()

  ClearPhotoGallery()

End

' ==================================================
'
'          Metodos privados
'
' ==================================================

Private Sub CreatePhotoPanels(photos As PhotoEntity[])

  Dim panelPhoto As Panel
  Dim formPhoto As FPhoto
  Dim photo As PhotoEntity
  Dim pictureBox As PictureBox

  $log4Gambas.Info("Creacion de paneles iniciales")
  For Each photo In photos
    panelPhoto = New Panel(PanelGalleryContent)
    panelPhoto.Width = $width
    panelPhoto.Height = $height
    panelPhoto.Border = Border.Plain
    panelPhoto.Arrangement = Arrange.Fill
    panelPhoto.Tag = photo.Id

    formPhoto = New FPhoto(photo, panelPhoto)
    formPhoto.Width = $width
    formPhoto.Height = $height

    panelPhoto.Show()
  Next

End

Private Sub ClearPhotoGallery()

  ' Destruir todos los controles
  For Each ctrl As Control In PanelGalleryContent.Children
    ctrl.Delete()
  Next

End
