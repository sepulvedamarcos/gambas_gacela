' Gambas class file

'
'
' Clase de acceso a datos en BD
'
'
Private $log4Gambas As Log4Gambas3
Private $dbContext As SQLiteContext
Private $configuration As Configuration
Private $titulo As String = "[PhotoRepository] "

Property Read DBContext As SQLiteContext

' ==================================================
'
'          Metodos publicos
'
' ==================================================
Public Sub _new(configuration As Configuration, logger As Log4Gambas3, context As SQLiteContext)

  $log4Gambas = logger
  $dbContext = context
  $configuration = configuration

End

Public Function getPhotos(Optional id As Integer) As PhotoEntity[]

  Dim photo As PhotoEntity
  Dim photos As PhotoEntity[]
  Dim photoResult As Result
  Dim query As String

  $log4Gambas.Debug($titulo & "Extraccion de fotos")

  query = "soft_delete = &1"
  If id > 0 Then
    query = "AND id = " & id
  End If

  photoResult = $dbContext.DBConnection.Find(Constants.TABLE_PHOTOS, query, False)

  If photoResult.Available Then
    $log4Gambas.Debug($titulo & "Extraccion de " & photoResult.Count & " fotos de la respuesta")

    Return MapResultToEntities(photoResult)

  Endif

Catch
  $log4Gambas.Error($titulo & "Problemas para recuperar las fotos " & Error.Text)
  Error.Propagate

End

Public Function FindWithFilters(whereClause As String, sortBy As String, sortOrder As String, limit As Integer, offset As Integer) As PhotoEntity[] '' Metodo para obtener los registros con filtros

  Dim result As Result
  Dim query As String
  Dim orderBy As String = "import_date"
  Dim orderType As String = "desc"

  $log4gambas.Debug($titulo & "Ejecutando query con filtros")

  If sortBy <> "" Then
    orderBy = orderBy
  Endif
  If sortOrder <> "" Then
    orderType = sortOrder
  Endif
  orderBy &= " " & orderType

  ' Ejecutar query con LIMIT y OFFSET
  ' En Gambas, Find no soporta directamente LIMIT/OFFSET
  ' Debemos usar Exec con SQL
  query = "SELECT * FROM " & Constants.TABLE_PHOTOS &
    " WHERE " & whereClause &
    " ORDER BY " & orderBy &
    " LIMIT " & limit &
    " OFFSET " & offset

  ' Convertir params a array para Exec
  result = $dbContext.DBConnection.Exec(query)

  If result.Available Then
    Return MapResultToEntities(result)
  Endif

Catch
  $log4gambas.Error($titulo & "Problema en FindWithFilters: " & Error.Text)

  Return New PhotoEntity[]

End

Public Function CountWithFilters(whereClause As String) As Integer '' Metodo para contar los regsitros que tiene la tabla de fotos

  Dim result As Result
  Dim query As String

  $log4gambas.Info($titulo & "Cuenta cantidad de fotos en la base actual")

  query = "SELECT COUNT(*) as total FROM " & Constants.TABLE_PHOTOS &
    " WHERE " & whereClause
  result = $dbContext.DBConnection.Exec(query)

  If result.Available Then
    Return result["total"]
  Endif

  Return 0

Catch
  $log4gambas.Error($titulo & "Problema en CountWithFilters: " & Error.Text)
  Error.Propagate

End

Public Function createPhoto(photo As PhotoEntity) As PhotoEntity

  Dim result As Result

  $dbContext.DBConnection.Begin()

  result = $dbContext.DBConnection.Create(Constants.TABLE_PHOTOS)

  result["file_name"] = photo.FileName
  result["width_pixels"] = photo.WidthPixels
  result["height_pixels"] = photo.HeightPixels
  result["creation_date"] = Now()
  result["import_date"] = photo.ImportDate
  result["description"] = photo.Description
  result["stars"] = photo.Stars & "x"
  result["import_user"] = photo.ImportUser
  result["image_path"] = photo.ImagePath
  result["hash256"] = photo.Hash256
  result["thumbnail"] = photo.Thumbnail
  result["last_sync_date"] = Null
  result["sync_status"] = 0
  result["soft_delete"] = False
  result["soft_deleted_date"] = Null
  result["soft_deleted_by"] = Null
  result["soft_deleted_auto"] = Null
  result["is_locked"] = False
  result["locked_by"] = Null
  result["locked_date"] = Null
  result["lock_reason"] = Null

  result.Update()

  $dbContext.DBConnection.Commit

Catch
  $dbContext.DBConnection.Rollback
  $log4gambas.Error($titulo & "Problemas al crear una foto, se hace Rollback")
  Error.Propagate

End

Public Function ValidateHash256Exist(hash256 As String) As Boolean

  Dim query As String
  Dim total As Integer
  Dim result As Result

  query = "SELECT COUNT(*) as total FROM " & Constants.TABLE_PHOTOS &
    " WHERE hash256 = &1"
  result = $dbContext.DBConnection.Exec(query, hash256)

  If result.Available Then
    total = result["total"]
    If total >= 1 Then
      Return True
    End If
  End If

  Return False

Catch
  $log4gambas.Error($titulo & "Error al buscar foto por hash256")
  Error.Propagate

End

Public Function FindAlbums(album As String) As AlbumEntity[]

  Dim query As String
  Dim result As Result

  query = "SELECT * FROM " & Constants.TABLE_ALBUMS
  If album <> "" Then
    query &= " WHERE name LIKE " & album
  Endif

  result = $dbContext.DBConnection.Exec(query)
  If Result.Available Then

  Endif

  Return []

Catch
  $log4gambas.Error($titulo & "Problema al leer los albums")
  Error.Propagate

End

' ==================================================
'
'          Metodos privados
'
' ==================================================

Private Function MapResultToEntities(result As Result) As PhotoEntity[] '' Mapeo de fotos

  Dim photo As PhotoEntity
  Dim photos As New PhotoEntity[]

  For Each Result
    photo = New PhotoEntity

    ' Mapear todos los campos
    photo.Id = result["id"]
    photo.FileName = result["file_name"]
    photo.WidthPixels = IIf(result["width_pixels"] <> Null, result["width_pixels"], 0)
    photo.HeightPixels = IIf(result["height_pixels"] <> Null, result["height_pixels"], 0)
    photo.CreationDate = result["creation_date"]
    photo.ImportDate = result["import_date"]
    photo.Description = result["description"]
    photo.Stars = result["stars"]
    photo.ImportUser = result["import_user"]
    photo.ImagePath = Result["image_path"]
    photo.Hash256 = result["hash256"]
    photo.Thumbnail = result["thumbnail"]
    photo.LastSyncDate = result["last_sync_date"]
    photo.SyncStatus = result["sync_status"]
    photo.SoftDelete = result["soft_delete"]
    photo.SoftDeleteDate = result["soft_deleted_date"]
    photo.SoftDeleteBy = result["soft_deleted_by"]
    photo.SoftDeleteAuto = result["soft_deleted_auto"]
    photo.IsLocked = result["is_locked"]
    photo.LockedBy = result["locked_by"]
    photo.Lockreason = result["lock_reason"]

    photos.Add(photo)

  Next

  Return photos

Catch
  $log4gambas.Error($titulo & "Problema en el mapeo de datos photo")
  Error.Propagate

End

Private Sub MapAlbumEntity(result As Result) As AlbumEntity[] '' Mapeo de albums

  Dim album As AlbumEntity
  Dim albums As AlbumEntity[]

  For Each album In result
    album = New AlbumEntity

    ' Mapeo todos los campos
    album.Id = result["id"]
    album.Name = result["name"]
    album.Description = result["description"]
    album.CreationDate = result["creation_date"]
    album.CreationUser = result["creation_user"]
    album.Thumbnail = result["thumbnail"]
    album.SoftDelete = result["soft_delete"]
    '
    albums.Add(album)
  Next

  Return albums

Catch
  $log4gambas.Error($titulo & "Problema en el mapeo de datos album")
  Error.Propagate

End

Private Function DBContext_Read() As SQLiteContext

  Return $dbContext

End
